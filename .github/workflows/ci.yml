name: Quality Gate

on:
  push:
    branches: [ "main", "staging" ]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [ "main", "staging" ]
    paths-ignore:
      - 'docs/**'
      - '**.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  pre_job:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5.3.1
        with:
          concurrent_skipping: 'always'
          skip_after_successful_duplicate: 'true'
          do_not_skip: '["push", "workflow_dispatch", "schedule"]'

  lint:
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2.0.1
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v5.0.3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Dependencies
        run: bun install --frozen-lockfile
      - name: Run Linter
        run: bun run lint

  test:
    needs: pre_job
    if: needs.pre_job.outputs.should_skip != 'true'
    runs-on: ubuntu-latest
    env:
      NODE_ENV: test
      PROCESS_PORT: "3000"
      PROCESS_DOMAIN: "http://localhost:3000"
      PROCESS_CORS_ORIGIN: "*"
      REDIS_SERVER: localhost
      REDIS_PORT: "6379"
      REDIS_PASSWORD: ""
      REDIS_SSL: "false"
      REDIS_STACK: "true"
      POSTGRES_SERVER: localhost
      POSTGRES_PORT: "5432"
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DATABASE: db
      RATE_LIMIT_MAX: "100"
      RATE_LIMIT_WINDOW: "60"
      AUTH_SALT: salt
      SHOW_LOG: "false"
      LOG_LEVEL: info
      APP_NAME: "Test App"
      APP_DESCRIPTION: "Test Description"
      APP_VERSION: "0.0.1"
      APP_FOLDER_KEY: "keys"
      APP_HTTP2: "false"
      APP_CERT: "keys/cert.pem"
      APP_KEY: "keys/key.pem"
      SSO_GOOGLE_CLIENT_ID: test-client-id
      SSO_GOOGLE_CLIENT_SECRET: test-client-secret
      SSO_GOOGLE_REDIRECT_URI: "http://localhost/callback"
    steps:
      - uses: actions/checkout@v6.0.2
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v5.0.3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Dependencies
        run: bun install --frozen-lockfile
      - name: Run Tests
        run: bun run tests


  build:
    runs-on: ubuntu-latest
    needs: [pre_job, lint, test]
    if: needs.pre_job.outputs.should_skip != 'true'
    steps:
      - uses: actions/checkout@v6.0.2
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Cache dependencies
        uses: actions/cache@v5.0.3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Dependencies
        run: bun install --frozen-lockfile
      - name: Build Project
        run: bun run build

import{M as a}from"./chunks/theme.BUFF_Lox.js";import{I as o,c as r,o as p,aF as t,J as k}from"./chunks/framework.CZ2lsOHd.js";const b=JSON.parse('{"title":"Scalable WebSockets (Redis Pub/Sub)","description":"","frontmatter":{},"headers":[],"relativePath":"servers/websockets.md","filePath":"servers/websockets.md"}'),d={name:"servers/websockets.md"},y=Object.assign(d,{setup(c){const s={type:"smoothstep",style:{stroke:"var(--vp-code-line-diff-add-symbol-color)",strokeWidth:1},animated:!0,markerEnd:a.ArrowClosed},e={type:"smoothstep",style:{stroke:"var(--vp-code-color)",strokeWidth:1},animated:!0,markerEnd:a.ArrowClosed},n=[{id:"c1",type:"multi-handle",label:"Client A",position:{x:0,y:0}},{id:"c2",type:"multi-handle",label:"Client B",position:{x:250,y:0}},{id:"s1",type:"multi-handle",label:"App Instance 1",position:{x:-25,y:150}},{id:"s2",type:"multi-handle",label:"App Instance 2",position:{x:221,y:150}},{id:"redis",type:"multi-handle",label:"Redis Pub/Sub",position:{x:100,y:350}}],l=[{id:"e1",source:"c1",target:"s1",sourceHandle:"bottom-source",targetHandle:"top",label:"WebSocket",...e},{id:"e2",source:"c2",target:"s2",sourceHandle:"bottom-source",targetHandle:"top",label:"WebSocket",...e},{id:"e3",source:"s1",target:"redis",sourceHandle:"right-source",targetHandle:"top",label:"Subscribe",...s},{id:"e4",source:"s2",target:"redis",sourceHandle:"left-source",targetHandle:"top",label:"Subscribe",...s},{id:"e5",source:"redis",target:"s1",sourceHandle:"left-source",targetHandle:"bottom",label:"Publish",...s,animated:!0},{id:"e6",source:"redis",target:"s2",sourceHandle:"right-source",targetHandle:"bottom",label:"Publish",...s,animated:!0}];return(g,i)=>{const h=o("InteractiveFlow");return p(),r("div",null,[i[0]||(i[0]=t('<h1 id="scalable-websockets-redis-pub-sub" tabindex="-1">Scalable WebSockets (Redis Pub/Sub) <a class="header-anchor" href="#scalable-websockets-redis-pub-sub" aria-label="Permalink to â€œScalable WebSockets (Redis Pub/Sub)â€">â€‹</a></h1><p>The boilerplate includes a production-ready, horizontally scalable WebSocket implementation using Redis Pub/Sub. This allows you to run multiple instances of your API (<code>app_server</code>) and ensuring that real-time messages reach all connected clients, regardless of which instance they are connected to.</p><h2 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to â€œArchitectureâ€">â€‹</a></h2><ul><li><strong>Subscriber-Only</strong>: The WebSocket endpoint is designed primarily for <strong>receiving</strong> real-time updates (server-to-client).</li><li><strong>Redis Bridge</strong>: The server acts as a bridge. When a client subscribes to a topic (e.g., <code>chat-room</code>), the server subscribes to the corresponding Redis channel.</li><li><strong>Broadcast</strong>: Messages published to Redis are automatically broadcast to all WebSocket clients subscribed to that topic across all replicas.</li></ul>',4)),k(h,{nodes:n,edges:l}),i[1]||(i[1]=t(`<h2 id="connection-details" tabindex="-1">Connection Details <a class="header-anchor" href="#connection-details" aria-label="Permalink to â€œConnection Detailsâ€">â€‹</a></h2><ul><li><strong>URL</strong>: <code>ws://localhost:3000</code> or <code>ws://localhost:5080</code> (or configured port)</li><li><strong>Protocol</strong>: JSON-based messages.</li></ul><h2 id="message-protocol" tabindex="-1">Message Protocol <a class="header-anchor" href="#message-protocol" aria-label="Permalink to â€œMessage Protocolâ€">â€‹</a></h2><h3 id="_1-connection-established" tabindex="-1">1. Connection Established <a class="header-anchor" href="#_1-connection-established" aria-label="Permalink to â€œ1. Connection Establishedâ€">â€‹</a></h3><p>Upon connection, the server sends:</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;connect&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;connection established&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;session&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;waiting for create session&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;session&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;YOUR_SESSION_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><blockquote><p><strong>Save the <code>session</code> ID</strong>, it is required for all subsequent requests.</p></blockquote><h3 id="_2-authorization-required" tabindex="-1">2. Authorization (Required) <a class="header-anchor" href="#_2-authorization-required" aria-label="Permalink to â€œ2. Authorization (Required)â€">â€‹</a></h3><p>You must authenticate using a valid JWT token before subscribing to topics.</p><p><strong>Request:</strong></p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;authorization&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;session&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;YOUR_SESSION_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;context&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Response:</strong></p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;session&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;session authenticated&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><h3 id="_3-subscribe-to-topic" tabindex="-1">3. Subscribe to Topic <a class="header-anchor" href="#_3-subscribe-to-topic" aria-label="Permalink to â€œ3. Subscribe to Topicâ€">â€‹</a></h3><p>Start receiving messages for a specific context.</p><p><strong>Request:</strong></p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;subscribe&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;session&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;YOUR_SESSION_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;context&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;chat-room&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Response:</strong></p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;subscribe&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;context subscribed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><h3 id="_4-unsubscribe" tabindex="-1">4. Unsubscribe <a class="header-anchor" href="#_4-unsubscribe" aria-label="Permalink to â€œ4. Unsubscribeâ€">â€‹</a></h3><p>Stop receiving messages.</p><p><strong>Request:</strong></p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;unsubscribe&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;session&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;YOUR_SESSION_ID&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;context&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;chat-room&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><strong>Response:</strong></p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;unsubscribe&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;context unsubscribed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><h2 id="ðŸ§ª-testing-guide" tabindex="-1">ðŸ§ª Testing Guide <a class="header-anchor" href="#ðŸ§ª-testing-guide" aria-label="Permalink to â€œðŸ§ª Testing Guideâ€">â€‹</a></h2><p>Follow these steps to verify the implementation using <strong>Postman</strong> (or any WebSocket client) and <strong>Redis CLI</strong>.</p><h3 id="step-1-connect" tabindex="-1">Step 1: Connect <a class="header-anchor" href="#step-1-connect" aria-label="Permalink to â€œStep 1: Connectâ€">â€‹</a></h3><ol><li>Open Postman.</li><li>Create a new <strong>WebSocket Request</strong>.</li><li>Enter URL: <code>ws://localhost:3000</code> (or <code>ws://localhost:5080</code> if testing docker-compose mapping).</li><li>Click <strong>Connect</strong>.</li><li>Copy the <code>session</code> ID from the response log.</li></ol><h3 id="step-2-authenticate" tabindex="-1">Step 2: Authenticate <a class="header-anchor" href="#step-2-authenticate" aria-label="Permalink to â€œStep 2: Authenticateâ€">â€‹</a></h3><ol><li>Send the Authorization JSON payload (see above) with a valid JWT. <blockquote><p><em>Note: If you are in a dev environment with auth disabled, you may skip this or send any string if the bypass is active.</em></p></blockquote></li></ol><h3 id="step-3-subscribe" tabindex="-1">Step 3: Subscribe <a class="header-anchor" href="#step-3-subscribe" aria-label="Permalink to â€œStep 3: Subscribeâ€">â€‹</a></h3><ol><li>Send the Subscribe JSON payload for the context <code>test-channel</code>.</li><li>Verify you receive the <code>context subscribed</code> confirmation.</li></ol><h3 id="step-4-publish-message-simulate-event" tabindex="-1">Step 4: Publish Message (Simulate Event) <a class="header-anchor" href="#step-4-publish-message-simulate-event" aria-label="Permalink to â€œStep 4: Publish Message (Simulate Event)â€">â€‹</a></h3><p>Since the WebSocket is subscriber-only, use Redis to simulate a backend event.</p><ol><li><p>Open your terminal.</p></li><li><p>Connect to the Redis container:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">podman</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> exec</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -it</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> redis-cli</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">REDIS_PASSWOR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">D</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p><em>(Default password in <code>.env</code> is typically <code>65QaKz4Hn2KN</code>)</em></p></li><li><p>Publish a message to the channel:</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">PUBLISH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test-channel</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{&quot;info&quot;: &quot;Hello from Redis&quot;}&#39;</span></span></code></pre></div></li></ol><h3 id="step-5-verify-receipt" tabindex="-1">Step 5: Verify Receipt <a class="header-anchor" href="#step-5-verify-receipt" aria-label="Permalink to â€œStep 5: Verify Receiptâ€">â€‹</a></h3><ol><li>Check Postman.</li><li>You should instantaneously receive:<div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;action&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;topic&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;test-channel&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;snapshot&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;info&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Hello from Redis&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li></ol>`,38))])}}});export{b as __pageData,y as default};
